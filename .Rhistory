fjd <- loadRData( file = file.path(firefolder, 'ESACCI-L3S_FIRE-BA-MODIS-AREA_2-fv5.1-JD-01-18.rda'))# fire day of year (doy)
# crop and change spatial resolution of fire stack
fcl30 <- crop(fcl,extent(br))# change extent of the image stack
fcl30 <- resample(fcl30, br, method="ngb")#resample
fjd30 <- crop(fjd,extent(br))
fjd30 <- resample(fjd30, br, method="ngb")
# # Locations that experienced fire
freloc <- (fre > 0) # areas that have experienced a fire get the value 1, other areas the value 0
# date vector associated with the fire stack
fdts<- as.Date(names(fcl), format = "X%Y%m%d") # dates associated with the fire data stack
# generate an image stack containing regular fire time series at the predefined temporal resolution with value 1 if a fire occured and 0 if no fire occured
tsFire <- calc(stack(freloc,fcl30, fjd30), function(x){createFireStack(x, dts = fdts, resol = tempRes, thres = 95)}, filename = paste0(ofolder, tsfile, '_Fire_', tempRes),overwrite=TRUE)
install()
library(raster)
library(ff)
library(UpscaleRecovery)
tsFire <- calc(stack(freloc,fcl30, fjd30), function(x){createFireStack(x, dts = fdts, resol = tempRes, thres = 95)}, filename = paste0(ofolder, tsfile, '_Fire_', tempRes),overwrite=TRUE)
# e <-  drawExtent()
# fst <- crop(stack(freloc,fcl30,fjd30),e)
# convert the fire data to a regular time series with same temporal resolution as the NBR series. Here, observations during fire events get the value 1 and other observations the value 0
tsFire <- calc(stack(freloc,fcl30,fjd30), function(x){createFireStack(x, fdts, resol = tempRes, thres = 95)}, filename = paste0(ofolder, tsfile, '_Fire_', tempRes), overwrite=TRUE)
# get the dates of the nbr and fire stacks
if(tempRes == 'monthly'){
dtsbr <- seq(min(dts), max(dts), by = "1 month")#"1 day"
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- fdts
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
}
save(dtsfr, file = file.path(ofolder, paste0(tsfile, '_Firedts_', tempRes)))
fdts
fdts[1]
dtsfr <- seq(fdts[1], fdts[length(fdts)], by = "3 months")
dtsfr
tsFire
dtsbr <- seq(min(dts), max(dts), by = "3 months")#"1 day"
tsbr
# get the dates of the time series observations
names(br) <- dts
dts <- as.Date(dts, format = "X%Y.%m.%d") ## needed as input in the helper function of get_m_agg
# Create regular time series
tsbr <- calc(stack(freloc,br), function(x){toRegularTSStack(x, dts, fun = tempFun, resol = tempRes)}, filename = paste0(ofolder, tsfile, '_', tempRes, '_', tempFun), overwrite=TRUE)
# e <-  drawExtent()
# fst <- crop(stack(freloc,fcl30,fjd30),e)
# convert the fire data to a regular time series with same temporal resolution as the NBR series. Here, observations during fire events get the value 1 and other observations the value 0
tsFire <- calc(stack(freloc,fcl30,fjd30), function(x){createFireStack(x, fdts, resol = tempRes, thres = 95)}, filename = paste0(ofolder, tsfile, '_Fire_', tempRes), overwrite=TRUE)
# get the dates of the nbr and fire stacks
if(tempRes == 'monthly'){
dtsbr <- seq(min(dts), max(dts), by = "1 month")#"1 day"
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- fdts
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
}
if(tempRes == 'quart'){
dtsbr <- seq(min(dts), max(dts), by = "3 months")#"1 day"
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- seq(fdts[1], fdts[length(fdts)], by = "3 months")
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
}
if(tempRes == 'quart'){
dtsbr <- seq(min(dts), max(dts), by = "3 months")#"1 day"
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- seq(fdts[1], fdts[length(fdts)], by = "3 months")
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
}
library(lubridate)
if(tempRes == 'quart'){
dtsbr <- seq(min(dts), max(dts), by = "3 months")#"1 day"
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- seq(fdts[1], fdts[length(fdts)], by = "3 months")
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
}
save(dtsfr, file = file.path(ofolder, paste0(tsfile, '_Firedts_', tempRes)))
save(dtsbr, file = file.path(ofolder, paste0(tsfile, '_dts_', tempRes, '_', tempFun)))
knitr::opts_chunk$set(echo = TRUE, eval= F)
library(UpscaleRecovery)
library(ggplot2)
library(raster)
library(rasterVis)
library(sp)
library(maps)
library(maptools)
library(ggmap)
library("ggplot2")
library("sf")
library('rgdal')
library(rnaturalearth)
library(rnaturalearthdata)
library("ggspatial")
library("RColorBrewer")
# folder where data is stored
ofolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\'
# base name of the recovery indicator files
basename <- c('LSTS_SantaRem_area', '_2000_2020_Stab_monthly_maxBreak_F_obspyr_12_inp_segmented_shortDenseTS_TRUE_nPre_2_nDist_12_nPostMin_4_nPostMax_6_h_15')
# directory where the figures will be stored
figfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Figures\\'
# lcfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CopernicusLandCover\\'
# folder where data is stored
ofolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\'
# base name of the recovery indicator files
basename <- c('LSTS_SantaRem_area', '_2000_2020_Stab_monthly_maxBreak_F_obspyr_12_inp_segmented_shortDenseTS_TRUE_nPre_2_nDist_12_nPostMin_4_nPostMax_6_h_15')
# directory where the figures will be stored
figfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Figures\\'
# lcfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CopernicusLandCover\\'
map.world <- map_data('world')
# load the recovery indicator raster stacks
stab1 <- stack(file.path(ofolder, paste0(basename[1],1, basename[2],'.gri')))
stab2 <- stack(file.path(ofolder, paste0(basename[1],2, basename[2],'.gri')))
stab3 <- stack(file.path(ofolder, paste0(basename[1],3, basename[2],'.gri')))
stab4 <- stack(file.path(ofolder, paste0(basename[1],4, basename[2],'.gri')))
# generate point coordinates of site centroids
(sites <- data.frame(longitude = c( mean(extent(stab1)[1:2]),  mean(extent(stab2)[1:2]), mean(extent(stab3)[1:2]),  mean(extent(stab4)[1:2])), latitude = c(mean(extent(stab1)[3:4]), mean(extent(stab2)[3:4]),mean(extent(stab3)[3:4]),  mean(extent(stab4)[3:4]))))
(sites <- st_as_sf(sites, coords = c("longitude", "latitude"),
crs = 4326, agr = "constant"))
ste <- 2
stm <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_monthly_max.gri')))
frm <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_monthly.gri')))
stq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_quart_max.gri')))
frq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_quart.gri')))
frq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_quart.gri')))
frq
dtsq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_dts_quart_max')))
dtsq
stq
plot(stq[1])
plot(stq[[1]])
plot(stq[[81]])
ifolder <- 'C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\' # directory with NBR data
ofolder <- 'C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\' # directory where the recovery indicators and temporary outputs will be saved
firefolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CCI_fire\\' #'\\\\WURNET.NL\\Homes\\keers001\\AppData\\FolderRedirection\\Desktop\\cci_fire2\\'
# directory where the fire data are stored
tsfile <- 'LSTS_SantaRem_area2_2000_2020'# name of the file with NBR time series
metafile <- 'LSTS_meta_SantaRem_area2_2000_2020'# metadata file of the NBR time series
firefile <- 'LSTS_FireArea_SantaRem_area2_2000_2020'# name of the file with the fire mask
tempRes <- 'quart' # daily, annual, monthly, or quart (yearly data not supported yet!)
tempFun <- 'max' # max or mean (function used for temporal aggregation of data)
timeThres <- 2 # in case of segmentations, the time period between the detected break and the disturbance should be less than timeThres years
slpThres <- 2 # the slope of the pre-disturbance period should be less than slpThres
# settings of the derived recovery indicators
# input: refers to the tine series pre-processing: raw (=no preprocessing), smoothed or segmented
# h: This parameter defines the minimal segment size either given as fraction relative to the sample size or as an integer giving the minimal number of observations in each segment.
# shortDenseTS: TRUE or FALSE. In case TRUE, the metrics are adjusted to be compatible with short, dense time series. In case FALSE, the input time series is assumed to have annual observations and at least 2 and 5 pre- and post-disturbance years, respectively.
# nPre: If shortDenseTS is TRUE, number of years prior to the disturbance used to calculate the pre-disturbance value
# nDist: If shortDenseTS is TRUE, number of months used to quantify the time series value during the disturbance
# nPostMin: If shortDenseTS is TRUE, min number of years after the disturbance used to quantify the recovery
# nPostMax: If shortDenseTS is TRUE, max number of years after the disturbance used to quantify the recovery
# tdist: the timing of the disturbance [observation number]
if((tempRes == 'monthly') || (tempRes == 'daily')){
funSet <- list('input' = c('raw', 'smoothed', 'segmented', 'raw', 'smoothed', 'segmented'),# settings for the recovery indicators
'shortDenseTS' = c( TRUE, TRUE, TRUE, TRUE, TRUE, TRUE),
'nPre' = c(2,2,2,2,2,2),
'nDist' = c(1,1,1,12,12,12),
'nPostMin' = c(0,0,0,4,4,4),
'nPostMax' = c(1,1,1,6,6,6),
'h' = c(0.15,0.15,0.15,0.15,0.15,0.15))
} else if (tempRes == 'annual'){
funSet <- list('input' = c('raw'),# settings for the recovery indicators
'shortDenseTS' = c( FALSE),
'nPre' = c(2),
'nDist' = c(12),
'nPostMin' = c(4),
'nPostMax' = c(6),
'h' = c(0.15))
}
br <- stack(paste0(ifolder,tsfile,'.tif'))# the data stack containing the vegetation response
br <- br[[-1]] # the first image is redundant, artefact from the GEE download script
meta <- read.csv(paste0(ifolder,metafile,'.csv'))# metadata associated with the image stack
dts <- as.Date(meta$system_time_start[-1],'%Y,%m,%d')# observation dates of the image stack
fre <- raster(paste0(ifolder,firefile,'.tif'))# raster of areas that experienced a fire (those have a value > 0)
fcl <- loadRData( file = file.path(firefolder, 'ESACCI-L3S_FIRE-BA-MODIS-AREA_2-fv5.1-CL-01-18.rda'))# fire confidence
fjd <- loadRData( file = file.path(firefolder, 'ESACCI-L3S_FIRE-BA-MODIS-AREA_2-fv5.1-JD-01-18.rda'))# fire day of year (doy)
min(dts)
max(dts)
dtsbr <- seq(min(dts), max(dts), by = "3 months")#"1 day"
min(dtsbr)
max(dtsbr)
st <- toRegularTS(dts, dts, fun='max', resol = 'quart')
min(tst)
min(st)
st
?ts
as.Date(st)
tempRes
tsfile
dtsbr <- as.Date(toRegularTS(dts, dts, fun='max', resol = tempRes))
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- as.Date(toRegularTS(fdts, fdts, fun='max', resol = tempRes))
# date vector associated with the fire stack
fdts<- as.Date(names(fcl), format = "X%Y%m%d") # dates associated with the fire data stack
# get the dates of the nbr and fire stacks
dtsbr <- as.Date(toRegularTS(dts, dts, fun='max', resol = tempRes))
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- as.Date(toRegularTS(fdts, fdts, fun='max', resol = tempRes))
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
save(dtsfr, file = file.path(ofolder, paste0(tsfile, '_Firedts_', tempRes)))
save(dtsbr, file = file.path(ofolder, paste0(tsfile, '_dts_', tempRes, '_', tempFun)))
library(UpscaleRecovery)
library(ggplot2)
library(raster)
library(rasterVis)
library(sp)
library(maps)
library(maptools)
library(ggmap)
library("ggplot2")
library("sf")
library('rgdal')
library(rnaturalearth)
library(rnaturalearthdata)
library("ggspatial")
library("RColorBrewer")
# folder where data is stored
ofolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\'
# base name of the recovery indicator files
basename <- c('LSTS_SantaRem_area', '_2000_2020_Stab_monthly_maxBreak_F_obspyr_12_inp_segmented_shortDenseTS_TRUE_nPre_2_nDist_12_nPostMin_4_nPostMax_6_h_15')
# directory where the figures will be stored
figfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Figures\\'
# lcfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CopernicusLandCover\\'
ste <- 2
stm <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_monthly_max.gri')))
frm <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_monthly.gri')))
stq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_quart_max.gri')))
frq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_quart.gri')))
dtsq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_dts_quart_max')))
dtsq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_dts_quart_max')))
stq
dtsfq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_dtsfire_quart')))
dtsfq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Firedts_quart')))
frq
ifolder <- 'C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\' # directory with NBR data
ofolder <- 'C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\' # directory where the recovery indicators and temporary outputs will be saved
firefolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CCI_fire\\' #'\\\\WURNET.NL\\Homes\\keers001\\AppData\\FolderRedirection\\Desktop\\cci_fire2\\'
# directory where the fire data are stored
tsfile <- 'LSTS_SantaRem_area2_2000_2020'# name of the file with NBR time series
metafile <- 'LSTS_meta_SantaRem_area2_2000_2020'# metadata file of the NBR time series
firefile <- 'LSTS_FireArea_SantaRem_area2_2000_2020'# name of the file with the fire mask
tempRes <- 'monthly' # daily, annual, monthly, or quart (yearly data not supported yet!)
tempFun <- 'max' # max or mean (function used for temporal aggregation of data)
timeThres <- 2 # in case of segmentations, the time period between the detected break and the disturbance should be less than timeThres years
slpThres <- 2 # the slope of the pre-disturbance period should be less than slpThres
# settings of the derived recovery indicators
# input: refers to the tine series pre-processing: raw (=no preprocessing), smoothed or segmented
# h: This parameter defines the minimal segment size either given as fraction relative to the sample size or as an integer giving the minimal number of observations in each segment.
# shortDenseTS: TRUE or FALSE. In case TRUE, the metrics are adjusted to be compatible with short, dense time series. In case FALSE, the input time series is assumed to have annual observations and at least 2 and 5 pre- and post-disturbance years, respectively.
# nPre: If shortDenseTS is TRUE, number of years prior to the disturbance used to calculate the pre-disturbance value
# nDist: If shortDenseTS is TRUE, number of months used to quantify the time series value during the disturbance
# nPostMin: If shortDenseTS is TRUE, min number of years after the disturbance used to quantify the recovery
# nPostMax: If shortDenseTS is TRUE, max number of years after the disturbance used to quantify the recovery
# tdist: the timing of the disturbance [observation number]
if((tempRes == 'monthly') || (tempRes == 'daily')){
funSet <- list('input' = c('raw', 'smoothed', 'segmented', 'raw', 'smoothed', 'segmented'),# settings for the recovery indicators
'shortDenseTS' = c( TRUE, TRUE, TRUE, TRUE, TRUE, TRUE),
'nPre' = c(2,2,2,2,2,2),
'nDist' = c(1,1,1,12,12,12),
'nPostMin' = c(0,0,0,4,4,4),
'nPostMax' = c(1,1,1,6,6,6),
'h' = c(0.15,0.15,0.15,0.15,0.15,0.15))
} else if (tempRes == 'annual'){
funSet <- list('input' = c('raw'),# settings for the recovery indicators
'shortDenseTS' = c( FALSE),
'nPre' = c(2),
'nDist' = c(12),
'nPostMin' = c(4),
'nPostMax' = c(6),
'h' = c(0.15))
}
br <- stack(paste0(ifolder,tsfile,'.tif'))# the data stack containing the vegetation response
br <- br[[-1]] # the first image is redundant, artefact from the GEE download script
meta <- read.csv(paste0(ifolder,metafile,'.csv'))# metadata associated with the image stack
dts <- as.Date(meta$system_time_start[-1],'%Y,%m,%d')# observation dates of the image stack
fre <- raster(paste0(ifolder,firefile,'.tif'))# raster of areas that experienced a fire (those have a value > 0)
fcl <- loadRData( file = file.path(firefolder, 'ESACCI-L3S_FIRE-BA-MODIS-AREA_2-fv5.1-CL-01-18.rda'))# fire confidence
fjd <- loadRData( file = file.path(firefolder, 'ESACCI-L3S_FIRE-BA-MODIS-AREA_2-fv5.1-JD-01-18.rda'))# fire day of year (doy)
# date vector associated with the fire stack
fdts<- as.Date(names(fcl), format = "X%Y%m%d") # dates associated with the fire data stack
dtsbr <- as.Date(toRegularTS(dts, dts, fun='max', resol = tempRes))
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- as.Date(toRegularTS(fdts, fdts, fun='max', resol = tempRes))
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
save(dtsfr, file = file.path(ofolder, paste0(tsfile, '_Firedts_', tempRes)))
save(dtsbr, file = file.path(ofolder, paste0(tsfile, '_dts_', tempRes, '_', tempFun)))
#
ifolder <- 'C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\' # folder with data characteristics
firefolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CCI_fire\\' #'\\\\WURNET.NL\\Homes\\keers001\\AppData\\FolderRedirection\\Desktop\\cci_fire2\\'
metafile <- 'LSTS_meta_SantaRem_area3_2000_2020'
meta <- read.csv(paste0(ifolder,metafile,'.csv'))# metadata associated with the image stack
dts <- as.Date(meta$system_time_start[-1],'%Y,%m,%d')# observation dates of the image stack
load( file = file.path(firefolder, 'ESACCI-L3S_FIRE-BA-MODIS-AREA_2-fv5.1-CL-01-18.rda'))# fire
fdts<- as.Date(names(clst), format = "X%Y%m%d") # dates associated with the fire data stack
library(lubridate)
dtsbr <- seq(min(dts), max(dts), by = "1 month")#"1 day"
dtsbr <- rollback(dtsbr, roll_to_first = TRUE, preserve_hms = TRUE)
dtsfr <- fdts
dtsfr <- rollback(dtsfr, roll_to_first = TRUE, preserve_hms = TRUE)
# folder where data is stored
ofolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Data\\'
# base name of the recovery indicator files
basename <- c('LSTS_SantaRem_area', '_2000_2020_Stab_monthly_maxBreak_F_obspyr_12_inp_segmented_shortDenseTS_TRUE_nPre_2_nDist_12_nPostMin_4_nPostMax_6_h_15')
# directory where the figures will be stored
figfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\20200107_Upscaling\\CaseStudy\\Figures\\'
# lcfolder <- 'C:\\Users\\keers001\\OneDrive - WageningenUR\\RETURN\\Data\\RETURN\\CopernicusLandCover\\'
ste <- 2
stm <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_monthly_max.gri')))
frm <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_monthly.gri')))
dtsm <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_dts_monthly_max')))
dtsfm <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Firedts_monthly')))
stq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_quart_max.gri')))
frq <- stack(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Fire_quart.gri')))
dtsq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_dts_quart_max')))
dtsfq <- loadRData(file.path(ofolder, paste0('LSTS_SantaRem_area',ste,'_2000_2020_Firedts_quart')))
frm
frq
stm
stq
dtsm
stab <- stack(file.path(ofolder, paste0(basename[1],ste, basename[2],'.gri')))
si <- 1
qu <- as.numeric(quantile(stab[[si]] , probs = c(0.001,0.25,0.5,0.75,0.999), na.rm = T))
tsmii <- matrix(NA,5,dim(stm)[3])
frmii <- matrix(NA,5,dim(frm)[3])
trmii <- matrix(NA,5,dim(stm)[3])
tsqii <- matrix(NA,5,dim(stq)[3])
frqii <- matrix(NA,5,dim(frq)[3])
trqii <- matrix(NA,5,dim(stq)[3])
startdt <- max(c(min(dtsm), min(dtsfm)))
enddt  <- min(c(max(dtsm), max(dtsfm)))
dtsst <- seq(startdt, enddt, by = "1 month")#"1 day"
# clip the stacks to the overlap period
indbr  <- which((dtsm > (startdt-1)) & (dtsm < (enddt+1)))
indfr  <- which((dtsfm > (startdt-1)) & (dtsfm < (enddt+1)))
stm <- st[[indbr]]
stm <- stm[[indbr]]
frm <- frm[[indfr]]
startdt <- max(c(min(dtsq), min(dtsfq)))
enddt  <- min(c(max(dtsq), max(dtsfq)))
dtsst <- seq(startdt, enddt, by = "1 month")#"1 day"
# clip the stacks to the overlap period
indbr  <- which((dtsq > (startdt-1)) & (dtsq < (enddt+1)))
indfr  <- which((dtsfq > (startdt-1)) & (dtsfq < (enddt+1)))
stq <- stq[[indbr]]
frq <- frq[[indfr]]
qu <- as.numeric(quantile(stab[[si]] , probs = c(0.001,0.25,0.5,0.75,0.999), na.rm = T))
tsmii <- matrix(NA,5,dim(stm)[3])
frmii <- matrix(NA,5,dim(frm)[3])
trmii <- matrix(NA,5,dim(stm)[3])
tsqii <- matrix(NA,5,dim(stq)[3])
frqii <- matrix(NA,5,dim(frq)[3])
trqii <- matrix(NA,5,dim(stq)[3])
for (ii in 1:5){# levels of the recovery index
minind <- Which(abs(stab[[si]] - qu[ii]) == minValue(abs(stab[[si]] - qu[ii])), cells=T)
tsmii[ii,] <- as.numeric(stm[minind[1]])
frmii[ii,] <- as.numeric(frm[minind[1]])
tmp <- ts(tsmii[ii,], frequency = 12)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trmii[ii,] <- trf
tsqii[ii,] <- as.numeric(stq[minind[1]])
frqii[ii,] <- as.numeric(frq[minind[1]])
tmp <- ts(tsqii[ii,], frequency = 12)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trqii[ii,] <- trf
}
for (ii in 1:5){# levels of the recovery index
minind <- Which(abs(stab[[si]] - qu[ii]) == minValue(abs(stab[[si]] - qu[ii])), cells=T)
tsmii[ii,] <- as.numeric(stm[minind[1]])
frmii[ii,] <- as.numeric(frm[minind[1]])
tmp <- ts(tsmii[ii,], frequency = 12)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trmii[ii,] <- trf
tsqii[ii,] <- as.numeric(stq[minind[1]])
frqii[ii,] <- as.numeric(frq[minind[1]])
tmp <- ts(tsqii[ii,], frequency = 4)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trqii[ii,] <- trf
}
ii
trmii[ii,]
frqii[ii,]
tmp <- ts(tsqii[ii,], frequency = 4)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trqii[ii,] <- trf
trqii[ii,]
for (ii in 1:5){# levels of the recovery index
minind <- Which(abs(stab[[si]] - qu[ii]) == minValue(abs(stab[[si]] - qu[ii])), cells=T)
tsmii[ii,] <- as.numeric(stm[minind[1]])
frmii[ii,] <- as.numeric(frm[minind[1]])
tmp <- ts(tsmii[ii,], frequency = 12)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trmii[ii,] <- trf
tsqii[ii,] <- as.numeric(stq[minind[1]])
# frqii[ii,] <- as.numeric(frq[minind[1]])
tmp <- ts(tsqii[ii,], frequency = 4)
datapp <- bfastpp(tmp, order = 1, lag = NULL, slag = NULL,
na.action = na.omit, stl = 'none')
bp <- breakpoints(response ~ trend, data = datapp, h = 0.15)
# Extract BFAST trend component and breaks
cf <- coef(bp)
tbp <- bp$breakpoints #observation number of break
indna <- which(is.na(tmp)==F)
tbp <- indna[tbp]   # correct observation number for missing values
#Derive trend component without missing values
bpf <- c(0, tbp, length(tmp))
trf <- rep(NA,length(tmp))
for(ti in 1:(length(bpf)-1)){
trf[(bpf[ti]+1):bpf[ti+1]] <- cf[ti,1] + ((cf[ti,2]*((bpf[ti]+1):bpf[ti+1])))
}
trqii[ii,] <- trf
}
ii
plot(zoo(tsmii,dsm))
plot(zoo(tsmii,dtsm))
tsmii
plot(zoo(tsmii[1,],dtsm))
plot(zoo(tsmii[1,],dtsm))
lines(zoo(trqii[i,],dtsm))
plot(zoo(tsmii[1,],dtsm))
lines(zoo(trqii[1,],dtsm))
lines(zoo(trqii[1,],dtsm), col = 'red')
plot(zoo(tsmii[1,],dtsm))
lines(zoo(trqii[1,],dtsm), col = 'red')
plot(zoo(tsmii[1,],dtsm))
lines(zoo(trmii[1,],dtsm), col = 'red')
lines(zoo(tsqii[1,],dtsq), col = 'green', lt = 'o')
plot(zoo(tsmii[1,],dtsm))
lines(zoo(trmii[1,],dtsm), col = 'red')
lines(zoo(tsqii[1,],dtsq), col = 'green', lt = 'o')
plot(zoo(tsmii[1,],dtsm))
lines(zoo(trmii[1,],dtsm), col = 'red')
lines(zoo(tsqii[1,],dtsq), col = 'green', type = 'o')
plot(zoo(tsmii[1,],dtsm), type = 'o')
lines(zoo(trmii[1,],dtsm), col = 'red')
lines(zoo(tsqii[1,],dtsq), col = 'green', type = 'o')
plot(zoo(tsmii[1,],dtsm), type = 'o')
lines(zoo(trmii[1,],dtsm), col = 'red')
lines(zoo(tsqii[1,],dtsq), col = 'green', type = 'o')
lines(zoo(trqii[1,],dtsq), col = 'blue')
